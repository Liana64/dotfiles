#!/bin/sh

INTERFACE="$1"
ACTION="$2"
NM_STATUS=$(${pkgs.networkmanager}/bin/nmcli -t -f type,state,connection dev)

WG_INTERFACE="wg0"
LOGFILE="/tmp/wg-autoconnect.log"

is_up() {
  ${pkgs.iproute2}/bin/ip link show "$WG_INTERFACE" &>/dev/null
}

is_ethernet() {
  echo "$NM_STATUS" | grep -q '^ethernet:connected'
}

is_trusted() {
  local current_ssid=$(echo "$NM_STATUS" | grep '^wifi:connected:' | sed 's/^wifi:connected://')
  [[ -z "$current_ssid" ]] && return 1
  [[ ! -f "${trustedNetworksFile}" ]] && return 1
  while IFS= read -r ssid; do
    [[ "$ssid" =~ ^#.*$ || -z "$ssid" ]] && continue
    ssid=$(echo "$ssid" | ${pkgs.findutils}/bin/xargs)
    [[ "$current_ssid" == "$ssid" ]] && return 0
  done < "${trustedNetworksFile}"
  return 1
}

[[ "$CONNECTIVITY_STATE" != "FULL" ]] && exit 0

case "$ACTION" in
  connectivity-change)
    NM_STATUS=$(${pkgs.networkmanager}/bin/nmcli -t -f type,state,connection dev)
    if is_ethernet || is_trusted; then
      #echo "  Trusted network - disconnecting VPN" >> "$LOGFILE"
      if is_up; then
        ${pkgs.wireguard-tools}/bin/wg-quick down "${wireguardConfigFile}"
      fi
    else
      #echo "  Untrusted network - connecting VPN" >> "$LOGFILE"
      if ! is_up; then
        ${pkgs.wireguard-tools}/bin/wg-quick up "${wireguardConfigFile}"
      fi
    fi
    ;;
esac
